include layouts/header
include institutionbody
include mixins/childInstitutionsTable
include mixins/modal-save-record
include mixins/projectByInstitutionTable
include mixins/peopleByInstitutionTable
include mixins/projectByInsCoFundersTable
include mixins/modal-validation-alert

.container.page-data
	form.form-horizontal(id="add_institution" method="post" action="/institutions/save_new" enctype="multipart/form-data")
				
		.div(style={'margin-top': '70px', 'margin-bottom': '70px'})
			.form-group.form-row(style={'padding-left': '0px', 'padding-right': '0px'})
				.col-md-12.mygroupheader
					.h5 INSTITUTION
						.btn-group-sm.float-right(role="group")
							button.btn.btn-primary.fa.fa-arrow-left#cancel(type='button') 
							button.btn.btn-primary.fa.fa-save#saveRecord(type='button' data-toggle="modal" data-target=".save-record")
					
			.editAdSection
				+institutionbody(data)

+modal-save-record
+modal-validation-alert

script(type='text/javascript').
	$(document).ready(function() {

		var needToConfirm = false; 
		$("select,input,textarea").change(function() {
			needToConfirm = true;
		});
		$(window).on("beforeunload", function(e) {
			if(needToConfirm==true) {
				var message = "Are you sure you want to leave?";
				e.returnValue = message;
				return message;
			}
			return;
		});

		$('#MOUStartDate,#MOUEndDate,#MOUExtendedOnDate').datepicker({ autoclose: true, dateFormat: 'M d, yy', todayHighlight: true });

		$("body").on("click", "#cancel", cancel);	

		//- $("#Province").devbridgeAutocomplete({
		//- 	lookup: provinces
		//- }); 

		//- $("#Country").devbridgeAutocomplete({
		//- 	lookup: countries
		//- }); 
              

		localStorage.removeItem("editedInstitutionCommReps");
		localStorage.removeItem("deletedInstitutionCommReps");

		addImagesToTableRows('institutionCommRepTable');


		$('#save-confirm').click(function(e){
			
			if (!FormValidation()) {return;}

			e.preventDefault();
			needToConfirm = false; 
			$(window).off("beforeunload");

			var formData = {
						'name' : $('input[name=InstitutionName]').val(),
						'acronym' : $('input[name=Acronym]').val()
			};
			
			$.ajax({
				type     : 'POST', 
				url      : '/institution_validate', 
				data     : formData, 
				dataType : 'json', 
				encode   : true
			}).done(function(data) {
					console.log(data.Qty); 
					if ( data.Qty=='0') {SaveInstitution(); } 
					else { $('#modal-validation-alert').modal('toggle'); }
			});




		});


		function SaveInstitution() {
			var actionurl = '/institutions/save_new';
			var formData =  $("#add_institution").serializeArray();
			$.ajax({
				url: actionurl,
				type: 'post',
				data: formData,
				success: function(data) {
					console.log('success');
					window.location = data;
				},
				error: function() { console.log('error');}
			});
		};

	});

	function cancel() {
		window.location.href = '/institutions';  

	};